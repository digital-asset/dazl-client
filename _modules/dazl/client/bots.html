<!DOCTYPE html>
<html lang="" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>dazl.client.bots</title>
  

  <link rel="apple-touch-icon" sizes="180x180" href="../../../_static/apple-touch-icon.png"/>
  <link rel="icon" type="image/png" href="../../../_static/favicon-32x32.png" sizes="32x32"/>
  <link rel="icon" type="image/png" href="../../../_static/favicon-16x16.png" sizes="16x16"/>
  <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="dazl 7.0.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 
</head>
<body>

   

  <header>
    dazl

  </header>
  <nav>
              
              
                
              
              
                <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../basics.html">Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../migrating.html">Migrate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dazl.html">dazl package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
</ul>

              

  </nav>
  <main>
    
  <h1>Source code for dazl.client.bots</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2019 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.</span>
<span class="c1"># SPDX-License-Identifier: Apache-2.0</span>

<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">asyncio</span> <span class="kn">import</span> <span class="n">ensure_future</span><span class="p">,</span> <span class="n">Future</span><span class="p">,</span> <span class="n">gather</span><span class="p">,</span> <span class="n">get_event_loop</span><span class="p">,</span> <span class="n">InvalidStateError</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">replace</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">auto</span><span class="p">,</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">RLock</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">overload</span><span class="p">,</span> <span class="n">AbstractSet</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">DefaultDict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> \
    <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">LOG</span>
<span class="kn">from</span> <span class="nn">..model.core</span> <span class="kn">import</span> <span class="n">Party</span><span class="p">,</span> <span class="n">SourceLocation</span>
<span class="kn">from</span> <span class="nn">..model.reading</span> <span class="kn">import</span> <span class="n">BaseEvent</span><span class="p">,</span> <span class="n">EventKey</span>
<span class="kn">from</span> <span class="nn">..model.writing</span> <span class="kn">import</span> <span class="n">Command</span><span class="p">,</span> <span class="n">CommandBuilder</span>
<span class="kn">from</span> <span class="nn">..util.asyncio_util</span> <span class="kn">import</span> <span class="n">LongRunningAwaitable</span><span class="p">,</span> <span class="n">completed</span><span class="p">,</span> <span class="n">propagate</span><span class="p">,</span> <span class="n">failed</span><span class="p">,</span> <span class="n">Signal</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.api</span> <span class="kn">import</span> <span class="n">PartyClient</span>

<span class="n">DEFAULT_BOT_STOP_TIMEOUT</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>


<span class="n">E</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">BaseEvent</span><span class="p">)</span>
<span class="n">BotCallback</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">E</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span>
<span class="n">BotFilter</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">E</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">_BotRunLevel</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">CONTINUE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">SUSPEND</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">TERMINATE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>


<div class="viewcode-block" id="Bot"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.Bot">[docs]</a><span class="k">class</span> <span class="nc">Bot</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">party_client</span><span class="p">:</span> <span class="s1">&#39;Optional[PartyClient]&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">:</span> <span class="n">DefaultDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">BotEntry</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_party_client</span> <span class="o">=</span> <span class="n">party_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[Signal]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idle</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_level</span> <span class="o">=</span> <span class="n">_BotRunLevel</span><span class="o">.</span><span class="n">CONTINUE</span>

<div class="viewcode-block" id="Bot.event_keys"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.Bot.event_keys">[docs]</a>    <span class="k">def</span> <span class="nf">event_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;AbstractSet[str]&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the set of keys that event handlers in this bot are configured to handle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">)</span></div>

<div class="viewcode-block" id="Bot.wants_any_keys"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.Bot.wants_any_keys">[docs]</a>    <span class="k">def</span> <span class="nf">wants_any_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="s1">&#39;Collection[str]&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">))</span></div>

<div class="viewcode-block" id="Bot.add_event_handler"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.Bot.add_event_handler">[docs]</a>    <span class="k">def</span> <span class="nf">add_event_handler</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="s1">&#39;Union[str, Collection[str]]&#39;</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="s1">&#39;BotCallback&#39;</span><span class="p">,</span>
            <span class="n">filter_fn</span><span class="p">:</span> <span class="s1">&#39;Optional[BotFilter]&#39;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a new event handler to this bot for the specified event.</span>

<span class="sd">        :param keys:</span>
<span class="sd">            The key(s) of the event (as returned by :meth:`EventKey.from_event`).</span>
<span class="sd">        :param filter_fn:</span>
<span class="sd">            An optional callback that returns `True` or `False` on whether the corresponding</span>
<span class="sd">            callback should be invoked. This cannot be a coroutine function.</span>
<span class="sd">        :param handler:</span>
<span class="sd">            An event handler to be invoked when an event with the specified key is raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;expected a string key&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;handler must be callable&#39;</span><span class="p">)</span>

        <span class="c1"># noinspection PyBroadException</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">source_file</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcefile</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">handler</span><span class="p">))</span>
            <span class="n">lines</span><span class="p">,</span> <span class="n">start_line</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
            <span class="n">end_line</span> <span class="o">=</span> <span class="n">start_line</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="n">source_loc</span> <span class="o">=</span> <span class="n">SourceLocation</span><span class="p">(</span><span class="n">source_file</span><span class="p">,</span> <span class="n">start_line</span><span class="p">,</span> <span class="n">end_line</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># noqa</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not compute original source information for </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">source_loc</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># noinspection PyProtectedMember</span>
            <span class="n">impl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party_client</span><span class="o">.</span><span class="n">_impl</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">wrap_as_command_submission</span><span class="p">(</span><span class="n">impl</span><span class="o">.</span><span class="n">write_commands</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">filter_fn</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BotEntry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">filter_fn</span><span class="p">,</span> <span class="n">source_loc</span><span class="p">))</span></div>

<div class="viewcode-block" id="Bot.ledger_created"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.Bot.ledger_created">[docs]</a>    <span class="k">def</span> <span class="nf">ledger_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_register_created</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_event_handler</span><span class="p">(</span><span class="n">EventKey</span><span class="o">.</span><span class="n">contract_created</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">template</span><span class="p">),</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_register_created</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The &quot;main&quot; coroutine of the bot. Invokes handlers on each event as they come in.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># noinspection PyBroadException</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_level</span> <span class="o">!=</span> <span class="n">_BotRunLevel</span><span class="o">.</span><span class="n">TERMINATE</span><span class="p">:</span>
                <span class="c1"># the main queue contains either events we have not yet processed yet or ``None``</span>
                <span class="c1"># markers that merely indicate running status should be &quot;re-checked&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_idle</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="p">:</span>
                    <span class="n">invocation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># noinspection PyBroadException</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fut</span> <span class="o">=</span> <span class="n">ensure_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_event</span><span class="p">(</span><span class="n">invocation</span><span class="o">.</span><span class="n">event</span><span class="p">))</span>
                        <span class="n">propagate</span><span class="p">(</span><span class="n">fut</span><span class="p">,</span> <span class="n">invocation</span><span class="o">.</span><span class="n">future</span><span class="p">)</span>
                        <span class="k">await</span> <span class="n">invocation</span><span class="o">.</span><span class="n">future</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># noqa</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;An event handler in a bot has thrown an exception! &#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;(offending event: </span><span class="si">{</span><span class="n">invocation</span><span class="o">.</span><span class="n">event</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_idle</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># noqa</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;A bot thread died abnormally.&#39;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_handle_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="s1">&#39;BaseEvent&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process an event, mostly by calling appropriate callbacks.</span>

<span class="sd">        :param event: The event to process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The _PartyClientImpl and Bot classes are the ones raising events, but to the user, they</span>
        <span class="c1"># registered from the perspective of a client with a certain thread affinity. Replace the</span>
        <span class="c1"># &quot;source&quot; of the event with the client that the user originally used.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_event</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_party_client</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_event</span> <span class="o">=</span> <span class="n">event</span>

        <span class="k">for</span> <span class="n">event_key</span> <span class="ow">in</span> <span class="n">EventKey</span><span class="o">.</span><span class="n">from_event</span><span class="p">(</span><span class="n">new_event</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Party </span><span class="si">%s</span><span class="s1"> dispatching event </span><span class="si">%r</span><span class="s1"> to its bots...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">party</span><span class="p">,</span> <span class="n">event_key</span><span class="p">)</span>
            <span class="n">handlers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">handlers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">handlers</span><span class="p">:</span>
                    <span class="c1"># noinspection PyBroadException</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">filter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">handler</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">new_event</span><span class="p">):</span>
                            <span class="n">fut</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">new_event</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isawaitable</span><span class="p">(</span><span class="n">fut</span><span class="p">):</span>
                                <span class="k">await</span> <span class="n">fut</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># noqa</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;An event handler in a bot has thrown an exception!&#39;</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Party </span><span class="si">%s</span><span class="s1"> finished handling events.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">party</span><span class="p">)</span>

<div class="viewcode-block" id="Bot.notify"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.Bot.notify">[docs]</a>    <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="s1">&#39;BaseEvent&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Awaitable[None]&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notifies handler(s) associated with this bot that the given event has occurred. Note that</span>
<span class="sd">        this notification is asynchronous: in other words, event handlers will not have processed</span>
<span class="sd">        this event by the time this function returns.</span>

<span class="sd">        :param event: The event to raise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">BaseEvent</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;expected a BaseEvent&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidStateError</span><span class="p">(</span><span class="s1">&#39;Cannot notify on a bot whose main method is not running&#39;</span><span class="p">)</span>
        <span class="n">bot_invocation</span> <span class="o">=</span> <span class="n">BotInvocation</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bot_invocation</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="o">.</span><span class="n">notify_all</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">bot_invocation</span><span class="o">.</span><span class="n">future</span></div>

    <span class="k">def</span> <span class="nf">_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="s1">&#39;BaseEvent&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">event_key</span> <span class="ow">in</span> <span class="n">EventKey</span><span class="o">.</span><span class="n">from_event</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event_key</span><span class="p">)</span>

    <span class="c1"># &lt;editor-fold desc=&quot;State control functions&quot;&gt;</span>

<div class="viewcode-block" id="Bot.pause"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.Bot.pause">[docs]</a>    <span class="k">def</span> <span class="nf">pause</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Immediately change the state of this bot to ``PAUSING``, and pause event handler</span>
<span class="sd">        invocations. The event handler currently running is allowed to complete. When that is</span>
<span class="sd">        completed, the state is changed to ``PAUSED``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Pausing the bot thread for party </span><span class="si">%r</span><span class="s1">...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">party</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_level</span> <span class="o">=</span> <span class="n">_BotRunLevel</span><span class="o">.</span><span class="n">SUSPEND</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="o">.</span><span class="n">notify_all</span><span class="p">()</span></div>

<div class="viewcode-block" id="Bot.resume"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.Bot.resume">[docs]</a>    <span class="k">def</span> <span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Immediately change the state of this bot to ``RESUMING`` and process any events that have</span>
<span class="sd">        queued up while the bot was paused. When this queue is fully drained, the state is changed</span>
<span class="sd">        to ``RUNNING``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Resuming the bot thread for party </span><span class="si">%r</span><span class="s1">...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">party</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_level</span> <span class="o">=</span> <span class="n">_BotRunLevel</span><span class="o">.</span><span class="n">CONTINUE</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="o">.</span><span class="n">notify_all</span><span class="p">()</span></div>

<div class="viewcode-block" id="Bot.stop"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.Bot.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Permanently stop this bot. If you need to be able to &quot;restart&quot; a stopped bot, use</span>
<span class="sd">        :meth:`pause` and :meth:`resume` instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Stopping the bot thread for party </span><span class="si">%r</span><span class="s1">...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">party</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_level</span> <span class="o">=</span> <span class="n">_BotRunLevel</span><span class="o">.</span><span class="n">TERMINATE</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="o">.</span><span class="n">notify_all</span><span class="p">()</span></div>

    <span class="c1"># &lt;/editor-fold&gt;</span>

    <span class="c1"># &lt;editor-fold desc=&quot;State query properties/functions&quot;&gt;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The ID of this bot, generated at runtime.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The name of this bot. Defaults to the name of the original event handler if unspecified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">party</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Party&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Primary party that this bot receives events for (and potentially generates commands for).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party_client</span><span class="o">.</span><span class="n">party</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_party_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

<div class="viewcode-block" id="Bot.entries"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.Bot.entries">[docs]</a>    <span class="k">def</span> <span class="nf">entries</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Sequence[BotEntry]&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The collection of individual event handlers in a bot, in the order that they will be</span>
<span class="sd">        executed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">entry</span> <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">collection</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BotState&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Current running state of the bot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_level</span> <span class="o">==</span> <span class="n">_BotRunLevel</span><span class="o">.</span><span class="n">CONTINUE</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BotState</span><span class="o">.</span><span class="n">RUNNING</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">BotState</span><span class="o">.</span><span class="n">STARTING</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_level</span> <span class="o">==</span> <span class="n">_BotRunLevel</span><span class="o">.</span><span class="n">TERMINATE</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BotState</span><span class="o">.</span><span class="n">STOPPED</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idle</span> <span class="k">else</span> <span class="n">BotState</span><span class="o">.</span><span class="n">STOPPING</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_level</span> <span class="o">==</span> <span class="n">_BotRunLevel</span><span class="o">.</span><span class="n">SUSPEND</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BotState</span><span class="o">.</span><span class="n">PAUSED</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idle</span> <span class="k">else</span> <span class="n">BotState</span><span class="o">.</span><span class="n">PAUSING</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">running</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return ``True`` if this bot is currently processing events.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_level</span> <span class="o">==</span> <span class="n">_BotRunLevel</span><span class="o">.</span><span class="n">CONTINUE</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idle</span><span class="p">)</span></div>

    <span class="c1"># &lt;/editor-fold&gt;</span>


<div class="viewcode-block" id="BotCollection"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.BotCollection">[docs]</a><span class="k">class</span> <span class="nc">BotCollection</span><span class="p">(</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Bot</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A collection of bots for a party.</span>

<span class="sd">    This class is thread-safe except for :meth:`notify` and :meth:`_main` in order to support adding</span>
<span class="sd">    event handlers from any thread. The most common use of this is for ``SimplePartyClient``</span>
<span class="sd">    instances, where event registration is done from the main thread (from the perspective of the</span>
<span class="sd">    caller) and event notifications are done on an asyncio event loop thread (hidden from the</span>
<span class="sd">    caller).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">party</span><span class="p">:</span> <span class="s1">&#39;Optional[Party]&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">party</span> <span class="o">=</span> <span class="n">party</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bots</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Bot]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fut</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[LongRunningAwaitable]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">RLock</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bots</span><span class="p">)</span>

    <span class="nd">@overload</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Bot</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">slice</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Bot</span><span class="p">]:</span> <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Bot</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">operator</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bots</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">bots</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bots</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">bots</span><span class="p">)</span>

<div class="viewcode-block" id="BotCollection.add_new"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.BotCollection.add_new">[docs]</a>    <span class="k">def</span> <span class="nf">add_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">party_client</span><span class="p">:</span> <span class="s1">&#39;Optional[PartyClient]&#39;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Bot&#39;</span><span class="p">:</span>
        <span class="n">bot</span> <span class="o">=</span> <span class="n">Bot</span><span class="p">(</span><span class="n">party_client</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bot</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># the _main coroutine has already started, so just add this bot&#39;s main method to the</span>
                <span class="c1"># set of coroutines we track</span>
                <span class="c1"># noinspection PyProtectedMember</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fut</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">bot</span><span class="o">.</span><span class="n">_main</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">bot</span></div>

<div class="viewcode-block" id="BotCollection.add_single"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.BotCollection.add_single">[docs]</a>    <span class="k">def</span> <span class="nf">add_single</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">keys</span><span class="p">:</span> <span class="s1">&#39;Union[str, Sequence[str]]&#39;</span><span class="p">,</span>
            <span class="n">handler</span><span class="p">:</span> <span class="s1">&#39;BotCallback&#39;</span><span class="p">,</span>
            <span class="n">filter_fn</span><span class="p">:</span> <span class="s1">&#39;Optional[BotFilter]&#39;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;Optional[str]&#39;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">party_client</span><span class="p">:</span> <span class="s1">&#39;Optional[PartyClient]&#39;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Bot&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method for creating a bot with a single event handler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># by default, the name of a single-event-handler bot is simply the name of the passed</span>
            <span class="c1"># in function</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">keys</span><span class="p">]</span>

        <span class="n">bot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_new</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">party_client</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">bot</span><span class="o">.</span><span class="n">add_event_handler</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">filter_fn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bot</span></div>

<div class="viewcode-block" id="BotCollection.notify"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.BotCollection.notify">[docs]</a>    <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="s1">&#39;BaseEvent&#39;</span><span class="p">):</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">event_keys</span> <span class="o">=</span> <span class="n">EventKey</span><span class="o">.</span><span class="n">from_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">bot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bots</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bot</span><span class="o">.</span><span class="n">wants_any_keys</span><span class="p">(</span><span class="n">event_keys</span><span class="p">):</span>
                    <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">bot</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">event</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa</span>
            <span class="c1"># This exception indicates a problem with the scheduling code and not user bot code.</span>
            <span class="c1"># Exceptions thrown by user code would be propagated through the Future</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Failed to notify event for party </span><span class="si">%s</span><span class="s1">: </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">party</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">completed</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">futures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">futures</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_main</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">party</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Party </span><span class="si">%s</span><span class="s1"> bots coroutine started.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">party</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Network bots coroutine started.&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fut</span> <span class="o">=</span> <span class="n">LongRunningAwaitable</span><span class="p">()</span>
            <span class="c1"># noinspection PyProtectedMember</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fut</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">bot</span><span class="o">.</span><span class="n">_main</span><span class="p">())</span> <span class="k">for</span> <span class="n">bot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bots</span><span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fut</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fut</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">party</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Party </span><span class="si">%s</span><span class="s1"> bots coroutine finished.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">party</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Network bots coroutine finished.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="BotCollection.stop_all"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.BotCollection.stop_all">[docs]</a>    <span class="k">def</span> <span class="nf">stop_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="c1"># LongRunningAwaitable suspends itself until all futures are completed. It also keeps</span>
            <span class="c1"># itself open waiting for the very first future. In the case that no other futures have</span>
            <span class="c1"># been added, take this opportunity to feed LongRunningAwaitable a future that</span>
            <span class="c1"># immediately resolves, which will have the effect of resolving that overall future</span>
            <span class="c1"># if there are no other futures (or the other futures are resolved as well); otherwise</span>
            <span class="c1"># this has no effect.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fut</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">completed</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">bot</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bots</span><span class="p">):</span>
                <span class="n">bot</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bots</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="BotEntry"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.BotEntry">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BotEntry</span><span class="p">:</span>
    <span class="n">event_key</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">callback</span><span class="p">:</span> <span class="n">BotCallback</span>
    <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BotFilter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">source_location</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SourceLocation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="BotInvocation"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.BotInvocation">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BotInvocation</span><span class="p">:</span>
    <span class="n">event</span><span class="p">:</span> <span class="n">BaseEvent</span>
    <span class="n">future</span><span class="p">:</span> <span class="n">Future</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_future</span><span class="p">())</span></div>


<div class="viewcode-block" id="BotState"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.BotState">[docs]</a><span class="k">class</span> <span class="nc">BotState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Possible states of a :class:`Bot`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">STARTING</span> <span class="o">=</span> <span class="s1">&#39;STARTING&#39;</span>  <span class="c1">#: The bot is starting (has not yet received the &quot;ready&quot; event).</span>
    <span class="n">PAUSING</span> <span class="o">=</span> <span class="s1">&#39;PAUSING&#39;</span>  <span class="c1">#: This bot has been told to pause, but has not yet completed processing events in flight.</span>
    <span class="n">PAUSED</span> <span class="o">=</span> <span class="s1">&#39;PAUSED&#39;</span>  <span class="c1">#:</span>
    <span class="n">RESUMING</span> <span class="o">=</span> <span class="s1">&#39;RESUMING&#39;</span>
    <span class="n">RUNNING</span> <span class="o">=</span> <span class="s1">&#39;RUNNING&#39;</span>
    <span class="n">STOPPING</span> <span class="o">=</span> <span class="s1">&#39;STOPPING&#39;</span>
    <span class="n">STOPPED</span> <span class="o">=</span> <span class="s1">&#39;STOPPED&#39;</span></div>


<span class="c1"># noinspection PyShadowingBuiltins</span>
<div class="viewcode-block" id="wrap_as_command_submission"><a class="viewcode-back" href="../../../dazl.client.html#dazl.client.bots.wrap_as_command_submission">[docs]</a><span class="k">def</span> <span class="nf">wrap_as_command_submission</span><span class="p">(</span><span class="n">submit_fn</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="nb">filter</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">BaseEvent</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize a callback to something that takes a single contract ID and contract data, and</span>
<span class="sd">    return an awaitable that is resolved when the underlying command has been fully submitted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">inspect</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">implementation</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">filter</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">completed</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;The callback </span><span class="si">%r</span><span class="s1"> threw an exception!&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">failed</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">completed</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="p">(</span><span class="n">CommandBuilder</span><span class="p">,</span> <span class="n">Command</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ret_fut</span> <span class="o">=</span> <span class="n">submit_fn</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;The callback </span><span class="si">%r</span><span class="s1"> returned commands that could not be submitted! (</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span>
                              <span class="n">callback</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">failed</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret_fut</span>
        <span class="k">elif</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isawaitable</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
            <span class="c1"># the user-provided callback returned an Awaitable</span>
            <span class="n">cmd_fut</span> <span class="o">=</span> <span class="n">ensure_future</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cmd_fut</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">cmd_fut</span><span class="o">.</span><span class="n">cancelled</span><span class="p">()</span> <span class="ow">or</span> <span class="n">cmd_fut</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># a cancelled or failed user-provided callback Future is the same as the</span>
                    <span class="c1"># command submission itself failing</span>
                    <span class="k">return</span> <span class="n">cmd_fut</span>

                <span class="c1"># functionally equivalent to the non-Awaitable case if the Awaitable has already</span>
                <span class="c1"># completed</span>
                <span class="k">return</span> <span class="n">submit_fn</span><span class="p">(</span><span class="n">cmd_fut</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># create `fut`, which we&#39;ll give to the user; wait for `cmd_fut` to finish, then</span>
                <span class="c1"># take the result of that awaitable and try to submit a command with that result</span>
                <span class="n">fut</span> <span class="o">=</span> <span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>

                <span class="k">def</span> <span class="nf">cmd_future_finished</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">cmd_fut</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">fut</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="p">(</span><span class="n">CommandBuilder</span><span class="p">,</span> <span class="n">Command</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                        <span class="n">propagate</span><span class="p">(</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">submit_fn</span><span class="p">(</span><span class="n">ret</span><span class="p">)),</span> <span class="n">fut</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isawaitable</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;A callback cannot return an Awaitable of an Awaitable&#39;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">InvalidStateError</span><span class="p">(</span>
                            <span class="s1">&#39;A callback cannot return an Awaitable of an Awaitable&#39;</span><span class="p">)</span>

                <span class="n">cmd_fut</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">cmd_future_finished</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">fut</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;the callback </span><span class="si">%r</span><span class="s1"> returned a value of an unexpected type: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unexpected return type from a callback&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">implementation</span></div>
</pre></div>

  </main>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'',
            VERSION:'7.0.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  <footer> 
  </footer>
</body>
</html>